pipeline {
    agent any
    options {
        ansiColor('xterm')
    }

    stages {
        stage("Cloning required repositories"){
            steps {
                // Cloning MAP-ETL-Framework-AirflowK8s Repo
                sh("mkdir ${HOME}/MAP-ETL-Framework-AirflowK8s")
                dir("${HOME}/MAP-ETL-Framework-AirflowK8s"){
                    git credentialsId: 'sangita_id_rsa',
                        url: "ssh://git@github.ibm.com/CIO-MAP/MAP-ETL-Framework-AirflowK8s.git",
                        branch: 'master'
                }

                // Cloning MAP-ETL-Framework Repo
                sh("mkdir ${HOME}/MAP-ETL-Framework")
                dir("${HOME}/MAP-ETL-Framework"){
                    git credentialsId: 'sangita_id_rsa',
                        url: "ssh://git@github.ibm.com/CIO-MAP/MAP-ETL-Framework.git",
                        branch: 'master'
                }

                
                sh("ls ${HOME}")
                sh("ls ${HOME}/MAP-ETL-Framework-AirflowK8s")
                sh("pwd")   
            }
        } //stage
        
        stage("Install Sonar Scanner") {
            environment{
                scannerBaseHome = "${HOME}/scannerBaseHome"
                scannerHome = "${scannerBaseHome}/sonar-scanner-4.7.0.2747-linux"

            }
            steps {

                // Install Sonar Scanner
                sh("mkdir ${scannerBaseHome} && cd ${scannerBaseHome} && wget --no-verbose -O sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.7.0.2747-linux.zip && unzip -qq sonar-scanner.zip && rm -rf sonar-scanner.zip")

                // copy the sonar-project.properties into conf directory of scannerHome
                sh("cp -rf sonar-project.properties ${scannerHome}/conf/")               
            }

        } //stage

        stage("Sonarqube Code Quality Check"){
            environment{
                scannerBaseHome = "${HOME}/scannerBaseHome"
                scannerHome = "${scannerBaseHome}/sonar-scanner-4.7.0.2747-linux"
                SONAR_SCANNER_OPTS = "-Djavax.net.ssl.trustStore=${HOME}/cacerts"
            }
            steps{
                // Importing the certificates
                withCredentials([file(credentialsId: 'ibm_root', variable: 'FILE')]){
                    sh "keytool -importcert -keystore cacerts -storepass changeit -file $FILE -alias 'ibm_root' -noprompt -trustcacerts"
                }

                // checking the Code Quality
                withCredentials([string(credentialsId: 'SONAR_TOKEN', variable: 'SONAR_TOKEN')]){
                    sh("${scannerHome}/bin/sonar-scanner -Dsonar.login=${SONAR_TOKEN}")
                    sh("${scannerHome}/bin/sonar-scanner -Dsonar.login=${SONAR_TOKEN} -Dsonar.projectBaseDir=${HOME}/MAP-ETL-Framework-AirflowK8s")

                }
                
            }
        } //stage
    } //stages
} //pipeline

